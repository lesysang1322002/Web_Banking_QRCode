<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EC banking</title>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">QR CODE BANKING</a>
          <div class="d-flex">
            <button class="btn btn-outline-warning" id="read">Scan</button>
          </div>
        </div>
      </nav>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
    .container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px; /* Khoảng cách giữa cột */
    }
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
    }

    .dropdown:hover .dropdown-content {
        display: block;
    }
    #imageToChange {
        /* display: block;
        margin: auto; */
        max-width: 100%;
        max-height: 100vh;
    }
    h5 {
        text-align: center;
    }
    .item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .item span {
        padding: 5px;
        border-bottom: 1px solid #ccc;
    }

    .item strong {
        text-align: right;
    }
    table {
    border-collapse: collapse;
    width: 100%;
    }
    th, td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }
    th {
        background-color: #f2f2f2;
    }
      </style>
</head>
<body>
    <div class="container mt-3">
    <div class="column">
        <div class="dropdown">
            <button  type="button" class="btn btn-dark btn-outline-warning" onclick="toggleDropdown()">Settings</button>
            <div class="dropdown-content">
              <select id="input1">
                <option value="970423">TP BANK</option>
                <option value="970405">AgriBank</option>
                <option value="970422">MB Bank</option>
                <option value="970418">BIDV</option>
                <option value="970432">VP Bank</option>
                <option value="970432">Techcombank</option>
                <option value="970443">SHB</option>
                <option value="970403">Sacombank</option>
                <option value="971005">ViettelMoney</option>
                <option value="971011">VNPTMoney</option>
                <option value="970448">OCB</option>
              </select>
              <br>
              <input type="text" id="input2" placeholder="Nhập số tài khoản">
              <br>
              <input type="text" id="input3" placeholder="Nhập số tiền">
              <button onclick="changeImage()">Cập nhật</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Mặt hàng</th>
                    <th>Giá</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td>Táo</td>
                    <td><input type="number" class="item-price" id = "apple" value="500" /> VND</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>Cam</td>
                    <td><input type="number" class="item-price" id = "orange" value="300" /> VND</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>Xoài</td>
                    <td><input type="number" class="item-price" id = "mango" value="400" /> VND</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>CoCa</td>
                    <td><input type="number" class="item-price" id = "coca" value="2500" /> VND</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>Snack</td>
                    <td><input type="number" class="item-price" id = "snack" value="1000" /> VND</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="column">
        <img id="imageToChange" src="https://api.vietqr.io/image/970448-0865420213-4XOF9m0.jpg?accountName=LE%20SY%20SANG&amount=0&addInfo=Thanh%20Toan">
    </div>
    <div class="column">
            <h5>HÓA ĐƠN THANH TOÁN</h5>
            <main>
            <div class="item">
                <span><strong>Tên Sản Phẩm</strong></span>
                <span><strong>Số Lượng</strong></span>
                <span><strong>Thành Tiền</strong></span>
            </div>

            <div class="item">
                <div id="Value1_1">
                    <span></span>
                </div>
                <div id="Value1_2">
                    <span></span>
                </div>
                <div id="Value1_3">
                    <span></span>
                </div>
            </div>
            <div class="item">
                <div id="Value2_1">
                    <span></span>
                </div>
                <div id="Value2_2">
                    <span></span>
                </div>
                <div id="Value2_3">
                    <span></span>
                </div>
            </div>
            <div class="item">
                <div id="Value3_1">
                    <span></span>
                </div>
                <div id="Value3_2">
                    <span></span>
                </div>
                <div id="Value3_3">
                    <span></span>
                </div>
            </div>
            <div class="item">
                <div id="Value4_1">
                    <span></span>
                </div>
                <div id="Value4_2">
                    <span></span>
                </div>
                <div id="Value4_3">
                    <span></span>
                </div>
            </div>
            <div class="item">
                <div id="Value5_1">
                    <span></span>
                </div>
                <div id="Value5_2">
                    <span></span>
                </div>
                <div id="Value5_3">
                    <span></span>
                </div>
            </div>
            <hr>
            <div class="item">
                <span><strong>Tổng cộng</strong></span>
                <span></span>
                <div id="Value4">
                <span><strong></strong></span>
            </div>
            </div>
            </main>
        <button type="button" class="btn btn-dark btn-outline-warning" id="start">START</button>
        <button type="button" class="btn btn-dark btn-outline-warning" id="stop">STOP</button>
        <button type="button" class="btn btn-dark btn-outline-warning" id="pay" onclick="PAY()" >PAY</button>
    </div>
    </div>
</body>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
      <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> 
      <script>
          var imgElement = document.getElementById("imageToChange");
        function changeImage() {
          var input1Value = document.getElementById("input1").value;
          var input2Value = document.getElementById("input2").value;
          var input3Value = document.getElementById("input3").value;
          if ((imgElement && input1Value && input2Value)|| (imgElement && input1Value && input2Value && input3Value)) {
              var baseUrl = "https://api.vietqr.io/image/";
              var newImageUrl = baseUrl + input1Value + "-" + input2Value + "-4XOF9m0.jpg?accountName=LE%20SY%20SANG&amount=" + input3Value +"&addInfo=%20chuyen%20khoan" ;
              console.log(newImageUrl);
              imgElement.src = newImageUrl;
          }}
    function toggleDropdown() {
    var dropdownContent = document.querySelector(".dropdown-content");
    if (dropdownContent.style.display === "block") {
        dropdownContent.style.display = "none";
    } else {
        dropdownContent.style.display = "block";
    }
    }
    var deviceName = 'QR CODE';
    var bleService = 'battery_service';
    var bleCharacteristic = 'battery_level';
    var bluetoothDeviceDetected;
    var gattCharacteristic;
    let sum = 0;
    $(document).ready(function() {

        $('#read').click(function() {
            if (isWebBluetoothEnabled()) { 
                read(); 
            }
        })

        $('#start').click(function() {
            if (isWebBluetoothEnabled()) { 
                if (isWebBluetoothEnabled()) { start() }
            }
        })


        $('#stop').click(function() {
            if (isWebBluetoothEnabled()) { 
                stop(); 
            }
        })

        $('#send').click(function(){
            if (isWebBluetoothEnabled()) { 
                send(); 
            }
        });

    });
    function isWebBluetoothEnabled() {
        if (!navigator.bluetooth) {
        console.log('Web Bluetooth API is not available in this browser!');
        log('Web Bluetooth API is not available in this browser!');
        return false
        }

        return true
    }

    function getDeviceInfo() {
        let options = {
        optionalServices: [bleService],
        filters: [
            { "name": deviceName }
        ]
        }

        console.log('Requesting any Bluetooth Device...');
        log('Đang tìm thiết bị...');
        return navigator.bluetooth.requestDevice(options).then(device => {
            bluetoothDeviceDetected = device;
            $('#read').text('Disconnect');
        }).catch(error => {
            console.log('Argh! ' + error);
            log('Argh! ' + error);
        })
    }

    function read() {
        return (bluetoothDeviceDetected ? Promise.resolve() : getDeviceInfo())
        .then(connectGATT)
        .then(_ => {
            console.log('Reading battery level...');
            return gattCharacteristic.readValue();
        })
        .catch(error => {
            console.log('Waiting to start reading: ' + error);
            log('Waiting to start reading: ' + error);
        })
    }
    function start() {
        var data = new TextEncoder().encode("1");
        gattCharacteristic.writeValue(data)
        console.log("Send data: " + data)
        gattCharacteristic.startNotifications()
        .then(_ => {
            console.log('Start reading...');
            log('Bắt đầu đo...');
            document.querySelector('#start').disabled = true;
            document.querySelector('#stop').disabled = false;
        })
        .catch(error => {
            console.log('[ERROR] Start: ' + error);
            log('[ERROR] Start: ' + error);
        })
    }

    function stop() {
        gattCharacteristic.stopNotifications().then(_ => {
            console.log('Dừng đo...');
            log('Stop reading...');
            document.querySelector('#start').disabled = false;
            document.querySelector('#stop').disabled = true;
        })
        .catch(error => {
            console.log('[ERROR] Stop: ' + error);
        })
    }

    function log(text) {
        const now = new Date();
        const prefixlog = now.getHours() + ':' + now.getMinutes() + ':'  + now.getSeconds() + '> ';

        $('.text-log').val($('.text-log').val() + prefixlog + text + '\n');
    }

    function Thanhtoan(text){
        var Value=text;
        imgElement.src="https://api.vietqr.io/image/970423-12221322002-4XOF9m0.jpg?accountName=LE%20SY%20SANG&amount="+Value+"&addInfo=Sang%20chuyen%20khoan"
    }

    function PAY(){
    // console.log(amout);
    const payload = {
        orderCode: orderCode,
        amount: sum,
        description: description,
        cancelUrl: cancelUrl,
        returnUrl: returnUrl,
    };
    console.log(payload);

    const sortedPayload = Object.keys(payload).sort().map(key => `${key}=${payload[key]}`).join('&');

    function generateHmac() {
        const key = "93dfbb7f5a1956fc58f6acc257564bf1cd12d113d0e8248ba1ac5047e5f772f8";
        const message = sortedPayload;
        const hmacSha256 = CryptoJS.HmacSHA256(message, key).toString(CryptoJS.enc.Hex);
        return hmacSha256;
    }

    console.log(generateHmac());
    payload.signature = generateHmac();
    payload.expiredAt = expiredAt;
    payload.buyerName = buyerName;
    payload.buyerEmail = buyerEmail;
    payload.buyerPhone = buyerPhone;
    payload.buyerAddress = buyerAddress;
    payload.items = items;
    fetch('https://api-merchant.payos.vn/v2/payment-requests', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-client-id' : '455c9f07-3048-41ac-979e-508b2408c9b2',
            'x-api-key'   :'bb992bcd-6aa3-4a36-992b-3ac3210c1c55'
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Yêu cầu không thành công');
        }
        return response.json();
    })
    .then(data => {
        if (data && data.desc) {
            const desc = data.desc;
            console.log(desc);
            console.log(data.data.checkoutUrl);
            window.location.href = data.data.checkoutUrl;
        } else {
            console.error('Dữ liệu trả về không chứa mô tả trạng thái');
        }
    })
    .catch(error => {
        console.error(error);
    });
   
    
    }

    function connectGATT() {
        if (bluetoothDeviceDetected.gatt.connected && gattCharacteristic) {
            return Promise.resolve()
        }

        return bluetoothDeviceDetected.gatt.connect()
        .then(server => {
            console.log('Getting GATT Service...');
            log('Đang kết nối với thiết bị...');
            return server.getPrimaryService(bleService);
        })
        .then(service => {
            console.log('Getting GATT Characteristic...');
            log('Kết nối thành công');
            return service.getCharacteristic(bleCharacteristic);
        })
        .then(characteristic => {
            gattCharacteristic = characteristic
            gattCharacteristic.addEventListener('characteristicvaluechanged', handleChangedValue)
            document.querySelector('#start').disabled = false;
            document.querySelector('#stop').disabled = true;
        })
    }
    let thanhtien1 = 0;
    let thanhtien2 = 0;
    let thanhtien3 = 0;
    let thanhtien4 = 0;
    let thanhtien5 = 0;
    let checkpush1 = false;
    let checkpush2 = false;
    let checkpush3 = false;
    let checkpush4 = false;
    let checkpush5 = false;
    function handleChangedValue(event) {
    let data = event.target.value;

    // Khởi tạo một mảng để chứa dữ liệu từ mảng uint8_t
    let dataArray = new Uint8Array(data.buffer);

    // Khởi tạo chuỗi để chứa dữ liệu từ mảng uint8_t
    let valueString = '';
    let kytu=String.fromCharCode(dataArray[0]);
    
    //Lặp qua mảng để trích xuất dữ liệu từng phần tử
    for (let i=0; i < dataArray.length; i++) {
        valueString += String.fromCharCode(dataArray[i]);
    }
    console.log(valueString);
    if (kytu=="1" && checkpush1==false){
        let soluong1 = parseFloat(valueString.substring(2, valueString.length));
        $('#Value1_1 span').text('Táo');
        $('#Value1_2 span').text(soluong1);
        $('#Value1_3 span').text($('#apple').val()*soluong1);
        thanhtien1 = parseFloat($('#apple').val()*soluong1);
        items.push({
            name: 'Táo',
            quantity: soluong1,
            price: thanhtien1
        });
        checkpush1 = true;
    }
    if (kytu=="2" && checkpush2==false){
        let soluong2 = parseFloat(valueString.substring(2, valueString.length));
        $('#Value2_1 span').text('Cam');
        $('#Value2_2 span').text(soluong2);
        $('#Value2_3 span').text($('#orange').val()*soluong2);
        thanhtien2 = parseFloat($('#orange').val()*soluong2);
        items.push({
            name: 'Cam',
            quantity: soluong2,
            price: thanhtien2
        });
        checkpush2 = true;
    }
    if (kytu=="3" && checkpush3==false){
    let soluong3 = parseFloat(valueString.substring(2, valueString.length));
    console.log(soluong3);
        $('#Value3_1 span').text('Xoài');
        $('#Value3_2 span').text(soluong3);
        $('#Value3_3 span').text($('#mango').val()*soluong3);
    thanhtien3 = parseFloat($('#mango').val()*soluong3);
    items.push({name: 'Xoài', quantity: soluong3, price: thanhtien3});
    checkpush3 = true;
    }
    if(kytu=="4" && checkpush4==false){
        $('#Value4_1 span').text('CoCa');
        $('#Value4_2 span').text('1');
        $('#Value4_3 span').text($('#coca').val());
        thanhtien4 = parseFloat($('#coca').val());
    items.push({name: 'CoCa', quantity: 1, price: thanhtien4});
    checkpush4 = true;
    }
    if(kytu=="5" && checkpush5==false){
        $('#Value5_1 span').text('Snack');
        $('#Value5_2 span').text('1');
        $('#Value5_3 span').text($('#snack').val());
        thanhtien5 = parseFloat($('#snack').val());
    items.push({name: 'Snack', quantity: 1, price: thanhtien5});
    checkpush5 = true;
    }
    sum = thanhtien1 + thanhtien2 + thanhtien3 + thanhtien4 + thanhtien5;
    $('#Value4 span').text(sum);
    }
    function randomThreeDigitNumber() {
        return Math.floor(Math.random() * 900) + 100;
    }
    let urlPay = "";
    const orderCode = randomThreeDigitNumber();
    let amount = 5000;
    const description = "NVHIO121";
    const buyerName = "";
    const buyerEmail = "";
    const buyerPhone = "";
    const buyerAddress = "";
    let items = [];
    const cancelUrl = "https://translate.google.com/?sl=en&tl=vi&text=AUTHORIZATIONS&op=translate";
    const returnUrl = "https://lesysang1322002.github.io/Web_Banking_QRCode";
    const expiredAt = Math.floor(Date.now() / 1000) + 3600; // Thời gian hết hạn: bây giờ + 1 giờ
    const signatureKey = "64319f6c98c01e5cb254f4304b95c8f3339bfcbb30c8b6e5831902f98c03b094"; // Khóa kiểm tra

    </script>
    </html>